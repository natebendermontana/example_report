---
title: "2024 Acme Corp Volunteer Program Analysis"
author: Nate Bender
date: "`r Sys.Date()`"
output:
  html_document:
    theme: spacelab
    css: css/styles.css
    toc: true
    toc_float: true
---

<hr style="border: 1px solid #004d65;">
<p align="center">
<img src="media/fake_company_logo.png" width="400">
</p>
```{r, include=F}
# default html themes
# ‚Äúdefault‚Äù, ‚Äúbootstrap‚Äù, ‚Äúcerulean‚Äù, ‚Äúcosmo‚Äù, ‚Äúdarkly‚Äù, ‚Äúflatly‚Äù, ‚Äújournal‚Äù, ‚Äúlumen‚Äù, ‚Äúpaper‚Äù, ‚Äúreadable‚Äù, ‚Äúsandstone‚Äù, ‚Äúsimplex‚Äù, ‚Äúspacelab‚Äù, ‚Äúunited‚Äù, ‚Äúyeti‚Äù
```

```{r, echo=F, warning = F, message = F}
knitr::opts_chunk$set(echo = F,
                      cache = F,
                      warning = FALSE,  
                      message = FALSE)
options(scipen = 999)

library(sf)
library(fontawesome)
library(tigris)
library(leaflet)
library(ggthemes)
library(ggplot2)
library(forcats)
library(here)
library(tidyr)
library(gt)
library(stringr)
library(ggpubr)
library(scales)
library(RColorBrewer)
library(ggtext)
library(knitr)
library(tidytext)
library(ggrepel)
library(purrr)
library(DT)
library(randomNames)
library(stringi)
library(dplyr)

```

```{r setup, include=FALSE}
# Set the custom theme globally
source('00_custom_theme.R')
theme_set(my_acme_theme)
```

```{r}
cities <- read.csv(here("data", "uscities.csv"))
```


```{r}
set.seed(1236378)

num_fake_rows <- 300 
start_date <- as.Date("2023-01-01", format = "%Y-%m-%d")
end_date <- as.Date("2024-12-31", format = "%Y-%m-%d")
num_unique_ids <- round(num_fake_rows * 0.6)  # 60% unique IDs
num_repeated_ids <- num_fake_rows - num_unique_ids  # 40% repeated IDs

unique_fake_ids <- stri_rand_strings(num_unique_ids, 18, pattern = "[A-Z0-9]")
repeated_fake_ids <- sample(unique_fake_ids, num_repeated_ids, replace = TRUE)
all_fake_ids <- c(unique_fake_ids, repeated_fake_ids)

city_sample <- cities %>%
  select(city, state_name, county_fips) %>%
  distinct() %>%
  sample_n(length(unique(all_fake_ids)), replace = TRUE)

seniority_levels <- c("Executive", "Management", "Contributor")
org_statuses <- c("Employee", "Intern")
org_status_probs <- c(0.95, 0.05)
org_groups <- c("Marketing", "Accounting", "Sales", "Finance", "Data", "Engineering")
org_groups_probs <- c(.17, .1, .21, .07, .14, .3)  # Employees distribution across departments

# Volunteer likelihood per department (e.g., Marketing and Sales are more likely to volunteer)
org_group_volunteer_probs <- c(
  "Marketing" = 0.6,   # 60% of Marketing employees volunteer
  "Accounting" = 0.3,  # 30% of Accounting employees volunteer
  "Sales" = 0.7,       # 70% of Sales employees volunteer
  "Finance" = 0.25,    # 25% of Finance employees volunteer
  "Data" = 0.5,        # 50% of Data employees volunteer
  "Engineering" = 0.4  # 40% of Engineering employees volunteer
)

# Create lookup table with department assignments
fake_attributes_lookup <- tibble(
  salesforce_id = unique(all_fake_ids),
  random_name = randomNames(n = length(unique(all_fake_ids)), name.order = "last.first"),
  first_name = sub(".*,\\s*", "", random_name),
  last_name = sub(",.*", "", random_name),
  seniority_level = sample(seniority_levels, length(unique(all_fake_ids)), replace = TRUE),
  org_status = sample(org_statuses, length(unique(all_fake_ids)), replace = TRUE, prob = org_status_probs),
  org_group = sample(org_groups, length(unique(all_fake_ids)), replace = TRUE, prob = org_groups_probs)
) %>%
  bind_cols(city_sample) %>%  
  select(-random_name) 

# Define activity probabilities
activity_probs <- c(
  community_cleanup = 0.30,
  mentorship_program = 0.10,
  nonprofit_fundraising = 0.15,  
  stem_workshops = 0.1,
  food_bank_support = 0.2,
  disaster_relief = 0.15,
  animal_shelter = 0.05,
  environmental_advocacy = 0.13
)

# Determine which employees volunteer based on department probabilities
fake_attributes_lookup <- fake_attributes_lookup %>%
  mutate(volunteer_flag = runif(n()) < org_group_volunteer_probs[org_group])

# Generate activities only for employees who volunteer
df_fake_activities <- fake_attributes_lookup %>%
  filter(volunteer_flag) %>%  # Only employees flagged as volunteers generate activity rows
  slice_sample(n = num_fake_rows, replace = TRUE) %>%  # Generate required activity rows
  transmute(
    salesforce_id,
    activity_type = sample(
      names(activity_probs), num_fake_rows, replace = TRUE, prob = activity_probs
    ),
    activity_desc = case_when(
      activity_type == "community_cleanup" ~ "Participated in a local park and neighborhood cleanup.",
      activity_type == "mentorship_program" ~ "Mentored students or young professionals on career skills.",
      activity_type == "nonprofit_fundraising" ~ "Helped organize and run a fundraising event for a nonprofit.",
      activity_type == "stem_workshops" ~ "Led a hands-on STEM education workshop for students.",
      activity_type == "food_bank_support" ~ "Assisted in sorting, packing, and distributing food at a food bank.",
      activity_type == "disaster_relief" ~ "Provided emergency aid and rebuilding support after a disaster.",
      activity_type == "animal_shelter" ~ "Volunteered at an animal shelter, assisting with pet care and adoptions.",
      activity_type == "environmental_advocacy" ~ "Participated in sustainability initiatives, including tree planting and advocacy.",
      TRUE ~ "General volunteer activity"
    ),
    activity_date = as.character(sample(seq(start_date, end_date, by = "day"), num_fake_rows, replace = TRUE)),
    is_activity = TRUE
  )

# Generate placeholder rows (employees who did not volunteer)
df_fake_placeholders <- fake_attributes_lookup %>%
  filter(!volunteer_flag) %>%
  transmute(
    salesforce_id,
    activity_type = NA_character_,
    activity_desc = NA_character_,
    activity_date = NA_character_,
    is_activity = FALSE
  )

# Combine activity records & placeholder records
df_deidentified <- bind_rows(df_fake_activities, df_fake_placeholders) %>%
  left_join(fake_attributes_lookup, by = "salesforce_id") %>%
  select(salesforce_id, first_name, last_name, city, state_name, county_fips, org_group, org_status, seniority_level, is_activity, everything())

```

```{r}
# Total US Alliance
total_employees <- df_deidentified %>%
  summarize(unique_ids = n_distinct(salesforce_id)) %>% 
  pull(unique_ids)

# total w one or more activities
total_employees_oneormore <- df_deidentified %>%
  group_by(salesforce_id) %>% 
  filter(is_activity == T) %>% 
  ungroup() %>% 
  summarize(unique_ids = n_distinct(salesforce_id)) %>% 
  pull(unique_ids)

# Total employees with no activity
total_employees_noengage <- df_deidentified %>%
  group_by(salesforce_id) %>% 
  filter(all(is_activity == F)) %>% 
  ungroup() %>% 
  summarize(unique_ids = n_distinct(salesforce_id)) %>% 
  pull(unique_ids)

# total unique activity types
total_activity_types <- df_deidentified %>% 
  filter(!is.na(activity_type)) %>% 
  summarize(unique_types = n_distinct(activity_type)) %>% 
  pull(unique_types)

# total unique activities
total_activities <- df_deidentified %>%
  filter(is_activity == T) %>% 
  summarize(n = n()) %>% 
  pull(n)

summary_stats <- df_deidentified %>%
  group_by(salesforce_id, first_name, last_name) %>% 
  summarize(
    total_activities = sum(is_activity, na.rm = TRUE), # Count activities (TRUE as 1)
    .groups = "drop"
  ) %>% 
  summarise(
    mean_activities = mean(total_activities, na.rm = TRUE),
    median_activities = median(total_activities, na.rm = TRUE),
    mode_activities = as.numeric(names(sort(table(total_activities), decreasing = TRUE)[1])),
    sd_activities = sd(total_activities, na.rm = TRUE),
    min_activities = min(total_activities, na.rm = TRUE),
    max_activities = max(total_activities, na.rm = TRUE),
    n = n()
  )

mean_activities <- summary_stats %>% pull(mean_activities) %>% round(1)
max_activities <- summary_stats %>% pull(max_activities) %>% round(1)

```

<hr style="border: 1px solid #004d65;">

<span class="header-text-highlight">**Intro**</span>

After recently finishing a few confidential reports for clients interested in understanding more about their data and programs, I decided to make up some data and bring together some of the more interesting analysis and visualization methods from that work into a report that I could share publicly to demonstrate my skills.

For this demonstration, I pretend the client ("Acme Corp") is an national organization and the use case is that they're interested in analyzing how their employees are engaging with the company volunteer program. There are a number of different ways that employees can use the company-sponsored volunteer hours, and the company would like to understand how the program is being utilized. 

<span class="header-text-highlight">**Goal**</span> 

This report demonstrates my abilities across the following:

- Tailoring my analysis to a variety of angles, e.g. temporal, spatial, and aggregating data at different levels. 
- Communicating results clearly, both in writing and through effective data vizualizations.
- Using R Markdown and additional css stylesheets and HTML to develop dynamic reports that are both beautiful and intuitive.

<hr style="border: 1px solid #004d65;">

# Setting The Stage
Hey Acme Corp, welcome to the Volunteer Program Report.  This report examines data for **2023 and 2024** and only **active employees** in relation to their participation with the company volunteer program.

There are **`r total_activity_types`** distinct ways that employees could participate with the volunteer program:

```{r}
data_sources <- tibble::tibble(
  Source = c(
    "All Employees",
    "Community Cleanup",
    "Mentorship Program",
    "Nonprofit Fundraising",
    "STEM Education Workshops",
    "Food Bank Support",
    "Disaster Relief Volunteering",
    "Animal Shelter Assistance",
    "Environmental Advocacy"
  ),
  date = c(
    "12/31/24", "12/31/24", "12/31/24", "12/31/24", 
    "12/31/24", "12/31/24", "12/31/24", "12/31/24", "12/31/24"
  ),
  Description = c(
    "All active employees",
    "Employees participate in local park and neighborhood cleanups to improve community spaces.",
    "Volunteers mentor students or young professionals, offering career guidance and skill development.",
    "Employees help organize and run fundraising events for nonprofit organizations.",
    "Volunteers lead hands-on STEM workshops for students, promoting careers in science and technology.",
    "Employees assist at food banks by sorting, packing, and distributing food to families in need.",
    "Volunteers provide emergency support in response to natural disasters, including aid distribution and rebuilding efforts.",
    "Employees spend time at animal shelters, helping with pet care, adoption events, and facility maintenance.",
    "Volunteers participate in environmental initiatives such as tree planting, advocacy campaigns, and sustainability education."
  )
)

data_sources %>%
  gt() %>%
  tab_header(
    title = md("**Data Sources**"),
  ) %>%
  cols_label(
    Source = "Source",
    date = "Date Collected",
    Description = "Description"
  ) %>%
  tab_style(
    style = list(
      cell_text(weight = "bold")
    ),
    locations = cells_column_labels(everything())) %>% 
  opt_horizontal_padding(scale = 3) %>% 
  # Add a border around the entire table
  opt_table_outline(style = "solid", width = px(3), color = "#004d65")
```

<hr style="border: 1px solid #004d65;">
# Overall activity

Let's start broadly with exploring the amount of volunteer activity ‚Äî I'll just shorten that to "activity" or "activities" from here on out ‚Äî with Acme Corp regardless of department. There are <span class="infographic-number">**`r total_employees`**</span> total employees. Of those, <span class="infographic-number">**`r total_employees_oneormore`**</span> participated in at least one Acme Corp activity at some point during the year, which together accounts for a total of <span class="infographic-number">**`r total_activities`**</span> unique activities. On average, employees participated in <span class="infographic-number">**`r mean_activities`**</span> activities across the two years in the data, and the most engaged volunteer in the company participated in <span class="infographic-number">**`r max_activities`**</span> activities. 

However, <span class="infographic-number">**`r total_employees_noengage`**</span> employees (<span class="infographic-sub-number">`r round(total_employees_noengage/total_employees,2)*100` percent!</span>) did not volunteer in any way. 

## Summary by Department {#teams-summary}
This table breaks these activities down by type and department. Not too much to dig into here yet ‚Äî it's mostly nice for reference or for informing things like annual reporting.

```{r, include = T, cache=F}
activity_table <- df_deidentified %>%
  filter(is_activity) %>%
  group_by(org_group, activity_type) %>%
  summarize(activity_count = n(), .groups = "drop") %>%
  pivot_wider(
    names_from = org_group,
    values_from = activity_count,
    values_fill = 0
  ) %>%
  mutate(
    Total = rowSums(select(., -activity_type), na.rm = TRUE)
  ) %>%
  rename(`Activity Type` = activity_type)

total_employees_table <- df_deidentified %>%
  group_by(org_group) %>%
  summarize(
    total_employees = n_distinct(salesforce_id),
    total_activities = sum(is_activity == TRUE),
    activities_per_employee = total_activities / total_employees,
    .groups = "drop"
  )

# Append "Total employees" row
total_employees_row <- total_employees_table %>%
  select(org_group, total_employees) %>%
  pivot_wider(names_from = org_group, values_from = total_employees) %>%
  mutate(
    `Activity Type` = "Total Employees",
    Total = NA
  )

# Append "activities per employee" row
activities_per_employee_row <- total_employees_table %>%
  select(org_group, activities_per_employee) %>%
  pivot_wider(names_from = org_group, values_from = activities_per_employee) %>%
  mutate(
    `Activity Type` = "Activities per Employee",
    Total = NA
  )

# Append "Total" row
total_row <- activity_table %>%
  select(-`Activity Type`) %>%
  summarise(across(everything(), \(x) sum(x, na.rm = TRUE))) %>%
  mutate(`Activity Type` = "Total")

# Combine rows into the final table
final_table <- activity_table %>%
  bind_rows(total_row)  %>%
  bind_rows(total_employees_row) %>%
  bind_rows(activities_per_employee_row) %>% 
  mutate(
    `Activity Type` = recode(
      `Activity Type`,
      "community_cleanup" = "Community Cleanup",
      "mentorship_program" = "Mentorship Program",
      "nonprofit_fundraising" = "Nonprofit Fundraising",
      "stem_workshops" = "STEM Education Workshops",
      "food_bank_support" = "Food Bank Support",
      "disaster_relief" = "Disaster Relief Volunteering",
      "animal_shelter" = "Animal Shelter Assistance",
      "environmental_advocacy" = "Environmental Advocacy"
    ),
    Total = case_when(
      is.na(Total) ~ "-",  # Replace NA with "-" for nice readability
      TRUE ~ as.character(Total)  # Convert numeric values to character for consistency
    )
  )
```

```{r include = T}
pretty_table <- final_table %>%
  gt() %>%
  cols_label(
    `Activity Type` = md("**Activity<br>Type**"),
    !!!setNames(md(paste0(org_groups)), org_groups),  # Dynamically renames groups
    Total = md("**Total**")
  ) %>%
  # cols_move(
  #   columns = c(`Ski`, `Bike`, `Climb`, `Run`, `Snowboard`, `Water`, `Other`, Total), after = `activity Type`
  # ) %>%
  cols_align(align = "left", columns = everything()) %>%
  fmt_number(
    columns = everything(),  # Apply to all numeric columns
    rows = `Activity Type` != "Activities per Employee", 
    decimals = 0
  ) %>%
  fmt_number(
    columns = everything(),  # Apply to all numeric columns
    rows = `Activity Type` == "Activities per Employee",  
    decimals = 1
  ) %>%
  tab_style(
    style = list(
      cell_text(weight = "bold")
    ),
    locations = cells_column_labels(everything())  
  ) %>%
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_body(rows = `Activity Type` == "Total")  
  ) %>% 
  # Add light grey background to "Total employees" and "activities per employee"
  tab_style(
    style = list(
      cell_fill(color = "grey90")
    ),
    locations = cells_body(
      rows = `Activity Type` %in% c("Total Employees", "Activities per Employee")
    )
  ) %>%
  # Add dark teal background and white text to "Total" row
  tab_style(
    style = list(
      cell_fill(color = "#004d65"),
      cell_text(color = "white", weight = "bold")
    ),
    locations = cells_body(
      rows = `Activity Type` == "Total"
    )
  ) %>%
  # modify the separator line between the two rows w grey background
  tab_style(
    style = list(
      cell_borders(sides = "bottom", color = "#929292", weight = px(1))
    ),
    locations = cells_body(
      rows = `Activity Type` == "Total Employees"
    )
  ) %>% 
  # Add a border around the entire table
  opt_table_outline(style = "solid", width = px(3), color = "#004d65") %>% 
  # and horiz padding to all
  opt_horizontal_padding(scale = 3)


pretty_table
```

```{r}
# total unique activities - 1
total_activities_amie <- df_deidentified %>%
  filter(is_activity == T, 
         salesforce_id=="0014P00002TMURrQAP") %>% 
  summarize(n = n()) %>% 
  pull(n)

# total unique activities - 2
total_activities_graham <- df_deidentified %>%
  filter(is_activity == T, 
         salesforce_id=="0014P00002TMRjzQAH") %>% 
  summarize(n = n()) %>% 
  pull(n)
```

```{r}
df_summary <- df_deidentified %>%
  group_by(org_group) %>%
  summarize(
    employee_count = n_distinct(salesforce_id),               
    activity_count = sum(is_activity, na.rm = TRUE),
    activities_per_member = activity_count / employee_count 
  ) %>%
  # Reorder org_group by employee_count before pivoting
  mutate(org_group = fct_reorder(org_group, -employee_count)) %>%
  pivot_longer(cols = c(employee_count, activity_count), 
               names_to = "type", 
               values_to = "count")

sales_metric <- df_summary %>%
  filter(org_group == "Sales" & type == "activity_count") %>% 
  pull(activities_per_member)

marketing_metric <- df_summary %>%
  filter(org_group == "Marketing" & type == "activity_count") %>% 
  pull(activities_per_member)
```

We can explore these total activities more deeply by comparing visually across the groups.
The **Sales department** is buoyed by high activity among some key folks like [random name, random name, random name...]. They're the second-largest department, yet produce `r round(sales_metric,1)` activities per employee ‚Äî more than any other department. 

However, at `r round(marketing_metric,1)` activities per employee, the **Marketing department** is not far behind either ‚Äî mostly thanks to lots of activity from [random name, random name, random name...]

```{r, echo=FALSE, fig.align="center", out.width="100%"}
df_summary$fill <- ifelse(
  df_summary$org_group == "Sales" & df_summary$type == "activity_count", "#00a2db", #cf7007
  ifelse(df_summary$type == "employee_count", "#004d65", "#00a2db")
)

sales_x <- which(levels(df_summary$org_group) == "Sales") + 1.2 
sales_y <- df_summary %>% filter(org_group == "Sales", type=="activity_count") %>% pull(count) + 20
curve_xend <- sales_x - .9
curve_yend <- sales_y - 14  


plot <- ggplot(df_summary, aes(x = org_group, y = count, fill = fill)) +
  geom_bar(stat = "identity", position = position_dodge()) +
  annotate(
    "text",
    x = sales_x+.05, y = sales_y, 
    label = sprintf("%.1f activities per employee", sales_metric),
    hjust = 0,
    size = 4,
    color = "black"
  ) +
  geom_curve(
    aes(x = sales_x, y = sales_y, xend = curve_xend, yend = curve_yend), 
    curvature = 0.3,
    arrow = arrow(length = unit(0.2, "cm")),
    color = "black"
  ) +
  labs(
    title = "The Sales department is chock-full of volunteers",
    x = "",
    y = "",
    fill = "Metric"
  ) +
  scale_fill_identity(guide = "legend", name = NULL,
                      labels = c("Employees", "Activities"),
                      breaks = c("#004d65", "#00a2db")  #orange: "#cf7007"
  )
plot

```

## Permutation Testing 
The next logical question after seeing these differences in the activity rates is, great, but *are those differences meaningful?* It's impossible to tell intuitively if the Sales department's activities-per-employee rate of `r activities_per_employee_row %>% select("Sales") %>% pull() %>% round(1)` is significant when compared to something like the Finance department's rate of `r activities_per_employee_row %>% select("Data") %>% round(1)`, or if that difference could just be due to chance. 

We can apply statistical testing to this question using an approach called permutation testing. This method assesses whether an observed difference between departments is meaningful by randomly shuffling the data, recalculating the difference, and repeating this thousands of times. In our case, the random shuffling simulates a fake world where there is no association between the department and each person's likelihood to participate. By comparing the original result to these random outcomes that behave under the assumption that there is no link between department and activity rate, we can see how unusual the original observed difference is relative to how common or unusual it would be when there is no association between those characteristics.

Let's use the **Sales department (highest per-employee activity rate) versus the Accounting department (lowest)** as an example. I ran 5,000 permutations, and we see that that the observed result is highly uncommon among the simulations. This is strong evidence that the differences between these departments are not due to chance; there is some sort of meaningful difference in the propensity of employees to volunteer.

```{r, echo=F, fig.align="center", out.width="100%"}
calculate_team_rate <- function(data) {
  rates <- data %>%
    group_by(org_group) %>%
    summarise(
      total_activities = sum(is_activity, na.rm = TRUE),
      total_members = n_distinct(salesforce_id),
      observed_rate = total_activities / total_members
    )
  
  high_rate <- rates %>% filter(org_group == team_high) %>% pull(observed_rate)
  low_rate <- rates %>% filter(org_group == team_low) %>% pull(observed_rate)
  
  diff_rate <- high_rate - low_rate
  return(diff_rate)
}

team_high <- "Sales"
team_low <- "Accounting"

df_filtered <- df_deidentified %>%
  filter(org_group %in% c(team_high, team_low))

observed_diff <- calculate_team_rate(df_filtered)
set.seed(42)  
n_sim <- 500  
permuted_diffs <- numeric(n_sim)

for (i in 1:n_sim) {
  shuffled_data <- df_filtered %>%
    mutate(is_activity = sample(is_activity))  # Shuffles the T/F is_activity values while keeping all else unchanged
  
  permuted_diffs[i] <- calculate_team_rate(shuffled_data)
}

p_value <- mean(abs(permuted_diffs) >= abs(observed_diff))
results_df <- data.frame(permuted_diffs = permuted_diffs)

obs_proportion <- mean(results_df$permuted_diffs >= observed_diff)
obs_abs_proportion <- mean(abs(results_df$permuted_diffs >= observed_diff))


p <- ggplot(results_df, aes(x = permuted_diffs)) +
  geom_histogram(binwidth = 0.02, boundary = 0)
max_y <- ggplot_build(p)$data[[1]] %>% 
  pull(count) %>% 
  max()

ggplot(results_df, aes(x = permuted_diffs)) +
  geom_histogram(binwidth = 0.02, fill = "#004d65", boundary = 0) +
  geom_vline(xintercept = observed_diff, color = "#e25b5b", size = 1) +
  annotate("text", x = observed_diff-.2, y = max_y-5,
           label = paste0("Observed difference:\n", round(observed_diff, 2)), size=4, color = "#e25b5b", fontface = "bold") +
  labs(
    title = "Sales v Accounting",
    subtitle = "Simulated differences in activity rates",
    x = "Difference",
    y = "Frequency\n"
  )

```

For context, here are the permutation results between the **Finance and Accounting departments**. Here we see that the observed result is much more common among the permutations; about 45% of the observations are just as extreme or more than it is. This overlap is technically a p-value (0.45), which lots of folks are at least semi-familiar with. With a p-value this large, the difference in volunteering rates between the Finance and Accounting departments teams is likely due to chance.

```{r, echo=F, fig.align="center", out.width="100%"}

team_high <- "Finance"
team_low <- "Accounting"

df_filtered <- df_deidentified %>%
  filter(org_group %in% c(team_high, team_low))

observed_diff <- calculate_team_rate(df_filtered)
set.seed(42)  
n_sim <- 500  
permuted_diffs <- numeric(n_sim)

for (i in 1:n_sim) {
  shuffled_data <- df_filtered %>%
    mutate(is_activity = sample(is_activity))  # Shuffles the T/F is_activity values while keeping all else unchanged
  
  permuted_diffs[i] <- calculate_team_rate(shuffled_data)
}

p_value <- mean(abs(permuted_diffs) >= abs(observed_diff))
results_df <- data.frame(permuted_diffs = permuted_diffs)

obs_proportion <- mean(results_df$permuted_diffs >= observed_diff)
obs_abs_proportion <- mean(abs(results_df$permuted_diffs >= observed_diff))

p <- ggplot(results_df, aes(x = permuted_diffs)) +
  geom_histogram(binwidth = 0.02, boundary = 0)
max_y <- ggplot_build(p)$data[[1]] %>% 
  pull(count) %>% 
  max()

ggplot(results_df, aes(x = permuted_diffs)) +
  geom_histogram(binwidth = 0.02, fill = "#004d65", boundary = 0) +
  geom_vline(xintercept = observed_diff, color = "#e25b5b", size = 1) +
  annotate("text", x = observed_diff-.2, y = max_y-5,
           label = paste0("Observed difference:\n", round(observed_diff, 2)), size=4, color = "#e25b5b", fontface = "bold") +
  labs(
    title = "Finance v Accounting",
    subtitle = "Simulated differences in activity rates",
    x = "Difference",
    y = "Frequency\n"
  )

```

## Individual Volunteers

For a true across-the-business leaderboard, let's look at the overall top 20 by raw number of volunteer activities: 

```{r, echo=FALSE, fig.align="center", out.width="100%"}
top_engagers_all <- df_deidentified %>%
  group_by(salesforce_id, first_name, last_name,org_group) %>%
  summarize(engaged = sum(is_activity), .groups = "drop")%>%
  ungroup() %>%
  arrange(desc(engaged)) %>%
  slice_head(n = 20) %>%  # Select top 10 overall
  mutate(full_name = paste(first_name, last_name))

all_plot <- ggplot(top_engagers_all, aes(x = reorder(full_name, engaged), y = engaged, fill = org_group)) +
  geom_bar(stat = "identity", show.legend = T) +
  coord_flip() +
  scale_x_reordered() +
  scale_y_continuous(breaks = seq(0, max(top_engagers_all$engaged), by = 10)) +
  scale_fill_manual(values = deidentified_color_pal)+
  labs(
    title = "Superhero Volunteers",
    x = "",
    y = "",
    fill = ""
  )+
  theme(
    plot.title = element_text(hjust = 0.05),
    legend.position = "bottom",
    legend.title = NULL
  )

all_plot

```

We can also break activity down by individuals across departments.

```{r, echo=FALSE, fig.align="center", out.width="100%"}
top_engagers <- df_deidentified %>%
  group_by(org_group, salesforce_id, first_name, last_name) %>%
  summarize(engaged = sum(is_activity), .groups = "drop")%>%
  group_by(org_group) %>%
  filter(rank(desc(engaged), ties.method = "first") <= 5) %>% 
  ungroup() %>% 
  mutate(full_name = paste(first_name, last_name),
         full_name = reorder_within(full_name, engaged, org_group))

final_plot <- ggplot(top_engagers, aes(x = full_name, y = engaged, fill = org_group)) +
  geom_bar(stat = "identity", show.legend = F) +
  facet_wrap(~ org_group, scales = "free_y", ncol = 2, nrow = 4) +
  coord_flip() +  
  scale_x_reordered() +
  scale_y_continuous(breaks = seq(0, max(top_engagers$engaged), by = 10)) +
  scale_fill_manual(values = deidentified_color_pal)+
  labs(
    title = "Top 5 Highest-Engaged per Department",
    x = "",
    y = ""
  )
final_plot

```

And look at what types of volunteering are most popular for each department. 

```{r}
library(ggradar)
library(patchwork)  # For arranging plots

activity_labels <- c(
  "community_cleanup" = "Community Cleanup",
  "mentorship_program" = "Mentorship Program",
  "nonprofit_fundraising" = "Nonprofit Fundraising",
  "stem_workshops" = "STEM Workshops",
  "food_bank_support" = "Food Bank Support",
  "disaster_relief" = "Disaster Relief",
  "animal_shelter" = "Animal Shelter",
  "environmental_advocacy" = "Environmental Advocacy"
)

global_max <- df_deidentified %>%
  filter(is_activity == TRUE) %>%
  count(activity_type) %>%
  summarise(max_engagement = max(n, na.rm = TRUE)) %>%
  pull(max_engagement)

create_radar_chart <- function(department_name, data) {
  df_filtered <- data %>%
    filter(is_activity == TRUE, org_group == department_name) %>%
    group_by(activity_type) %>%
    summarise(engagement_count = n(), .groups = 'drop') %>%
    mutate(activity_type = recode(activity_type, !!!activity_labels)) 

  # Check if department has engagement data
  if (nrow(df_filtered) == 0) {
    print(paste("No engagement data for", department_name))
    return(NULL)  # Skip if no data
  }

  # Normalize engagement counts using the **global max across all departments**
  df_normalized <- df_filtered %>%
    mutate(engagement_count = engagement_count / global_max) %>%
    pivot_wider(names_from = activity_type, values_from = engagement_count, values_fill = 0)

  # Add an identifier column for ggradar
  df_radar <- df_normalized %>%
    mutate(org_group = department_name) %>%
    select(org_group, everything())

  # Assign department color
  color <- deidentified_color_pal[department_name]

  # Create radar chart
  ggradar(df_radar, 
          grid.min = 0, grid.mid = 0.5, grid.max = 1, 
          values.radar = c("0", "0.5", "1"),
          axis.labels = colnames(df_radar)[-1],
          plot.title = department_name,
          group.colours = color,
          axis.label.size = 5,
          group.point.size = 3,
          fill = T,
          fill.alpha = .5)+
        theme(plot.margin = margin(10, 20, 10, 20))  
}

# Example usage (replace "Marketing" with the desired department)
radar_marketing <- create_radar_chart("Marketing", df_deidentified)
radar_data <- create_radar_chart("Data", df_deidentified)
radar_sales <- create_radar_chart("Sales", df_deidentified)
radar_accounting <- create_radar_chart("Accounting", df_deidentified)


```

```{r}
radar_data + radar_marketing

```

```{r}
radar_sales + radar_accounting
```


## Departmental Volunteering 
Another way to look at the activity across departments is by breaking down the percentage of employees in each department who either participated in at least one activity versus those who did not participate at all.

```{r, echo=F}
for_plot <- df_deidentified %>%
  #filter(!salesforce_id %in% c("0014P00003E9Db9QAF", "0014P000033WuTcQAK")) %>% 
  group_by(org_group, salesforce_id) %>%
  summarize(engaged = any(is_activity), .groups = "drop") %>%
  group_by(org_group) %>%
  summarize(
    engaged = sum(engaged),
    didnotengage = n() - sum(engaged),
    .groups = "drop"
  ) %>%
  pivot_longer(cols = c(engaged, didnotengage), names_to = "Activity_Status", values_to = "Count") %>%
  group_by(org_group) %>%
  mutate(Percentage = Count / sum(Count) * 100) %>%
  ungroup()%>%
  mutate(
    org_group = fct_reorder(
      org_group,
      Percentage * (Activity_Status == "engaged"),
      .fun = sum,
      .desc = TRUE
    )
  )

for_plot_overall <- df_deidentified %>%
  group_by(salesforce_id) %>%
  summarize(engaged = any(is_activity), .groups = "drop") %>%
  summarize(
    engaged = sum(engaged),
    didnotengage = n() - sum(engaged),
    .groups = "drop"
  ) %>%
  pivot_longer(cols = c(engaged, didnotengage), names_to = "Activity_Status", values_to = "Count") %>%
  mutate(
    org_group = "Overall",
    Percentage = Count / sum(Count) * 100
  )

for_plot <- bind_rows(for_plot, for_plot_overall) %>%
  ungroup() %>%
  mutate(
    org_group = factor(
      org_group,
      levels = c("Overall", "Marketing", "Sales", "Data", "Engineering", "Finance", "Accounting")
    )
  )

overall_plot_data <- for_plot %>%
  filter(org_group == "Overall")

for_plot <- for_plot %>%
  filter(org_group != "Overall")

main_plot <- ggplot(for_plot, aes(x = org_group, y = Percentage, 
                                  fill = Activity_Status)) +
  geom_bar(stat = "identity", alpha = .9) +
  scale_fill_manual(
    values = c("engaged" = "#004d65", "didnotengage" = "#e25b5b"),
    labels = c("engaged" = "Engaged", "didnotengage" = "Did Not Engage")
  ) +  labs(
    #title = "Who Showed Up? ",
    subtitle = "Percent of Acme Corp who <span style='color:#004d65; font-size:20px;'><b>volunteered</b></span> vs.<br><span style='color:#e25b5b; font-size:20px;'><b>did not volunteer</b></span> in any way.",
    x = "",
    y = "Percentage",
    fill = ""
  ) +
  scale_y_continuous(limits = c(0,101), labels = label_percent(scale = 1)) +
  theme(
    #axis.text.x = element_text(angle = 0, hjust = .5),
    # axis.title.x = element_text(size = 12),
    axis.title.y = element_blank(),
    legend.position = "none",
    plot.subtitle = element_markdown(size = 16)
  )

overall_plot <- ggplot(overall_plot_data, aes(x = org_group, y = Percentage, fill = Activity_Status)) +
  geom_bar(stat = "identity", alpha = .9) +
  scale_fill_manual(
    values = c("engaged" = "#004d65", "didnotengage" = "#e25b5b"),
    labels = c("engaged" = "Engaged", "didnotengage" = "Did Not Engage")
  ) +
  scale_y_continuous(limits = c(0,101), labels = label_percent(scale = 1)) +
  labs(
    x = NULL,
    y = NULL
  ) +
  theme_fivethirtyeight() +
  theme(
    axis.text.x = element_text(angle = 0, hjust = 0.5, face = "bold"),
    axis.text.y = element_blank(),
    axis.title.y = element_blank(),
    legend.position = "none"
  )

final_plot <- ggpubr::ggarrange(
  main_plot, overall_plot,
  ncol = 2, widths = c(3.5, 1),
  align = "hv"
)
final_plot

```

## Overall Distribution

A flip side of the activity coin is looking at employees who did not volunteer in any way.

```{r, fig.align="center", out.width="100%", fig.height=5, fig.width=8}
for_plot <- df_deidentified %>%
  group_by(salesforce_id, first_name, last_name) %>% 
  summarize(
    total_activities = sum(is_activity, na.rm = TRUE), # Count activities (TRUE as 1)
    .groups = "drop"
  )

ggplot(for_plot, aes(x = total_activities)) +
  geom_histogram(binwidth = 1, fill = "#004d65", color = "#d8d8d8", alpha = 0.9) +
  labs(
    title = "Over half the company\ndid not volunteer at all",
    x = "\nActivities",
    y = "Number of Employees\n"
  ) +
  scale_x_continuous(breaks = seq(0, max(for_plot$total_activities), by = 1)
  ) +
  theme_fivethirtyeight()+
  theme(
    axis.title.x = element_text(size = 12),
    axis.title.y = element_text(size = 12)
  )
```

## Activity by Seniority
I was also curious if the seniority was associated with different levels of overall volunteerism. However, there don't appear to be notable differences in the volunteer rates among the different types of employees.

```{r, echo=F}
for_plot <- df_deidentified %>%
  group_by(seniority_level, salesforce_id) %>%
  summarize(engaged = any(is_activity), .groups = "drop") %>%
  group_by(seniority_level) %>%
  summarize(
    engaged = sum(engaged),
    didnotengage = n() - sum(engaged),
    .groups = "drop"
  ) %>%
  pivot_longer(cols = c(engaged, didnotengage), names_to = "Activity_Status", values_to = "Count") %>%
  group_by(seniority_level) %>%
  mutate(Percentage = Count / sum(Count) * 100) %>%
  ungroup()%>%
  mutate(
    seniority_level = fct_reorder(
      seniority_level,
      Percentage * (Activity_Status == "engaged"),
      .fun = sum,
      .desc = TRUE
    )
  )

for_plot_overall <- df_deidentified %>%
  group_by(salesforce_id) %>%
  summarize(engaged = any(is_activity), .groups = "drop") %>%
  summarize(
    engaged = sum(engaged),
    didnotengage = n() - sum(engaged),
    .groups = "drop"
  ) %>%
  pivot_longer(cols = c(engaged, didnotengage), names_to = "Activity_Status", values_to = "Count") %>%
  mutate(
    seniority_level = "Overall",
    Percentage = Count / sum(Count) * 100
  )

for_plot <- bind_rows(for_plot, for_plot_overall) %>%
  ungroup()

overall_plot_data <- for_plot %>%
  filter(seniority_level == "Overall")

for_plot <- for_plot %>%
  filter(seniority_level != "Overall") %>% 
  mutate(    seniority_level = factor(
    seniority_level,
    levels = c("Executive", "Management", "Contributor")
  ))

main_plot <- ggplot(for_plot, aes(x = seniority_level, y = Percentage, 
                                  fill = Activity_Status)) +
  geom_bar(stat = "identity", alpha = .9) +
  scale_fill_manual(
    values = c("engaged" = "#004d65", "didnotengage" = "#e25b5b"),
    labels = c("engaged" = "Engaged", "didnotengage" = "Did Not Engage")
  ) +  labs(
    #title = "",
    subtitle = "Percent of Acme Corp who <span style='color:#004d65; font-size:20px;'><b>volunteered</b></span><br>vs. <span style='color:#e25b5b; font-size:20px;'><b>did not volunteer</b></span> in any way.",
    x = "",
    y = "Percentage",
    fill = ""
  ) +
  scale_y_continuous(limits = c(0,101), labels = label_percent(scale = 1)) +
  theme_fivethirtyeight()+
  theme(
    axis.text.x = element_text(angle = 0, hjust = .5),
    axis.title.x = element_text(size = 12),
    axis.title.y = element_blank(),
    legend.position = "none",
    plot.subtitle = element_markdown(size = 16)
  )

overall_plot <- ggplot(overall_plot_data, aes(x = seniority_level, y = Percentage, fill = Activity_Status)) +
  geom_bar(stat = "identity", alpha = .9) +
  scale_fill_manual(
    values = c("engaged" = "#004d65", "didnotengage" = "#e25b5b"),
    labels = c("engaged" = "Engaged", "didnotengage" = "Did Not Engage")
  ) +
  scale_y_continuous(limits = c(0,101), labels = label_percent(scale = 1)) +
  labs(
    x = NULL,
    y = NULL
  ) +
  theme_fivethirtyeight() +
  theme(
    axis.text.x = element_text(angle = 0, hjust = 0.5, face = "bold"),
    axis.text.y = element_blank(),
    axis.title.y = element_blank(),
    legend.position = "none"
  )

final_plot <- ggpubr::ggarrange(
  main_plot, overall_plot,
  ncol = 2, widths = c(2.5, 1),
  align = "hv"
)
final_plot

```

## Who's Not Showing Up?
### The Non-Participants
You can explore the specific people within these non-participating employees in the [Activity by Department](#team-activity) section.

```{r, echo=F,  fig.align="center", out.width="100%"}
for_plot <- df_deidentified %>%
  mutate(seniority_level = factor(seniority_level, levels = c("Executive", "Management", "Contributor"))) %>% 
  filter(!org_status=="Intern") %>% 
  group_by(salesforce_id) %>% 
  # the "all" is crucial - it asks if all rows for a given id are FALSE and therefore shows only the employees who did not engage in any way
  filter(all(is_activity == F)) %>% 
  summarize(salesforce_id = first(salesforce_id),
            first_name = first(first_name),
            last_name = first(last_name), 
            seniority_level = first(seniority_level),
            org_group = first(org_group)) %>%
  group_by(org_group, seniority_level) %>%
  summarize(count = n(), .groups = "drop")

ggplot(for_plot, aes(x = reorder(org_group, count, FUN="sum", decreasing=T), y = count, fill = seniority_level)) +
  geom_bar(stat = "identity", position = "stack") +
  labs(
    x = "",
    y = "Count\n",
    fill = "Investment Level"
  ) +
  scale_x_reordered() +
  scale_fill_manual(values = de_id_invest_color_pal)+
  theme(
    axis.title.y = element_text(size = 12, angle = 90)
  ) 

```

## Top Interns
```{r}
top_prospects <- df_deidentified %>%
  filter(org_status=="Intern") %>% 
  mutate(
    full_name = paste(first_name, last_name),
    # original
    # activity_details = coalesce(activity_title, activity_desc) %>%
    #   str_trim()  
    activity_details = "Details redacted"
  ) %>%
  select(salesforce_id, full_name, org_group, activity_type, is_activity, activity_details)

num_prospects <- n_distinct(top_prospects$salesforce_id)

num_engaged_prospects <- top_prospects %>%
  filter(is_activity == TRUE) %>%
  summarise(num_engaged = n_distinct(salesforce_id)) %>%
  pull(num_engaged)

num_activities <- top_prospects %>%
  filter(is_activity == TRUE) %>%
  summarize(n = n()) %>%
  pull(n)
```

There were **`r num_prospects`** interns, **`r num_engaged_prospects`** of which participated in **`r num_activities`** activities.

```{r}
pretty_table <- top_prospects %>%
  filter(is_activity==T) %>% 
  select(-is_activity, -salesforce_id) %>% 
  arrange(full_name) %>%  # Sort alphabetically by first name
  gt() %>%
  # Style column labels
  cols_label(
    full_name = "Name",
    org_group = "Group",
    activity_type = "Activity Type",
    activity_details = "Details"
  ) %>%
  cols_align(align = "left", columns = everything()) %>%
  opt_horizontal_padding(scale = 3) %>% 
  tab_style(
    style = list(
      cell_text(weight = "bold")
    ),
    locations = cells_column_labels(everything())  
  ) %>% 
  # Add a border around the entire table
  opt_table_outline(style = "solid", width = px(3), color = "#004d65") %>% 
  opt_horizontal_padding(scale = 3)

pretty_table
```

# Spatial Analysis

## Activity by State

Interactive map of volunteer activity by employee state. Hover to see totals. 
```{r, echo=FALSE, warning=FALSE, message=FALSE}

#Summarize number of activities per state
activity_by_state <- df_deidentified %>%
  filter(is_activity == TRUE) %>%
  group_by(state_name) %>%
  summarise(total_activities = n(), .groups = "drop")

# Load US state boundaries
shapefile_path <- here("data", "s_05mr24/s_05mr24.shp")
states_sf <- st_read(shapefile_path, quiet = T) %>%
  rename(state_name = NAME)

# Merge activity data with state boundaries
map_data <- left_join(states_sf, activity_by_state, by = "state_name")

# Replace NA values with 0 (states with no activities)
map_data$total_activities[is.na(map_data$total_activities)] <- 0

# Define color palette
bins <- seq(1, 31, by = 10)  # 1-10, 11-20, ..., 61-70
#bins <- c(1, 6, 11, 16, 21, 26, 31)  # Explicit bin edges for categories
my_pal <- colorRampPalette(brewer.pal(9,"YlOrRd")[4:9])
#selected_colors <- my_pal(10)[seq(1, 10, by = 2)]  # Every second color
selected_colors <- my_pal(length(bins) - 1)  # Match number of bins


pal <- colorBin(palette = selected_colors, 
                domain = map_data$total_activities, 
                bins = bins, 
                na.color = "transparent")

map_data <- st_transform(map_data, crs = 4326)

leaflet(map_data) %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  #    addProviderTiles(providers$Esri.WorldImagery) %>%
  
  setView(lng = -98.5795, lat = 39.8283, zoom = 3) %>%
  addPolygons(
    fillColor = ~pal(total_activities),
    weight = 1,
    opacity = 1,
    color = "white",
    dashArray = "3",
    fillOpacity = ~ifelse(total_activities == 0, 0, 0.9),  # Set transparency for 0 activities
    highlight = highlightOptions(
      weight = 2,
      color = "#00a2db",
      bringToFront = TRUE
    ),
    label = ~paste0(state_name, ": ", total_activities),
    labelOptions = labelOptions(
      style = list("font-weight" = "bold"),
      direction = "auto"
    )
  ) %>%
  addLegend(
    pal = pal,
    values = map_data$total_activities,
    position = "bottomright",
    title = "Total Activities",
    opacity = 0.7,
    labFormat = function(type, cuts, p) {
      #labels <- c("1 - 5", "6 - 10", "11 - 15", "16 - 20")
      labels <- paste0(cuts[-length(cuts)], " - ", cuts[-1] - 1)  # Create dynamic range labels
      labels
    }
  )

```

```{r fig.height=15, fig.width=8}
# bar chart

bin_labels <- paste0(bins[-length(bins)], " - ", bins[-1] - 1)  # Creates: "1-10", "11-20", ...

activity_by_state <- activity_by_state %>%
  mutate(
    activity_bin = cut(
      total_activities,
      breaks = bins,
      #labels = c("1 - 5", "6 - 10", "11 - 15", "16 - 20"),
      labels = bin_labels,  # Use dynamically created labels
      include.lowest = TRUE
    )
  )

activity_by_state %>%
  arrange(desc(total_activities)) %>%
  mutate(state_name = fct_reorder(state_name, total_activities)) %>%  # Order by activity
  ggplot(aes(x = state_name, y = total_activities, fill = activity_bin)) +
  geom_bar(stat = "identity", color = "transparent", width = 0.8) +
  coord_flip() +
  scale_fill_manual(
    values = selected_colors, 
    guide = guide_legend(reverse = F)  
  ) +
  labs(
    x = NULL,
    y = "Activities",
    fill = "",
    title = "Total Activities by State"
  ) +
  theme(
    axis.text.y = element_text(size = 8),
    axis.text.x = element_text(size = 9),
    legend.position = "top"
  )
```


# Timeline Analysis
## Annual Timeline
```{r}
total_activities_validdates <- df_deidentified %>%
  filter(is_activity == T, !is.na(activity_date)) %>% 
  summarize(n = n()) %>% 
  pull(n)

validdates_perc <- round((total_activities_validdates / total_activities)*100,0)
```

```{r, echo=FALSE, fig.align="center", out.width="100%"}
library(ggh4x)
library(lubridate)

set.seed(12432)

for_timeline <- df_deidentified %>%
  mutate(
    activity_date = as.Date(activity_date),
    activity_week = as.Date(cut(activity_date, breaks = "week")),  # Group by week
    year = format(activity_week, "%Y"),  # Extract year
    month = format(activity_week, "%b")  # Extract month
  ) %>%
  filter(!is.na(activity_date)) %>% 
  group_by(activity_week, year, month) %>%
  summarize(count = n(), .groups = "drop")

weekly_avg <- round(mean(for_timeline$count, na.rm = TRUE), 2)

timeline_plot <- ggplot(for_timeline, aes(x = activity_week, y = count)) +
  geom_line(size = 1, color = "#004d65") +
  scale_x_date(
    breaks = seq(
      from = floor_date(min(for_timeline$activity_week), "year"),  # Start from the first day of the min year
      to = ceiling_date(max(for_timeline$activity_week), "year") - months(3),  # End before next year's Q1
      by = "3 months"
    ),
    labels = function(x) format(x, "%b")  # Display month abbreviations (Jan, Apr, Jul, Oct)
  ) +
  facet_wrap(~year, scales = "free_x", nrow = 1) +
  labs(
    title = "How Does Volunteering Vary\nThroughout the Year?",
    subtitle = "Counts by week",
    x = "Date",
    y = "Activity Count",
    color = "Department"
  ) +
  theme_fivethirtyeight() +
  theme(
    axis.text.x = element_text(angle = 0, hjust = 0.5),
    plot.title = element_text(vjust = 1),
    strip.text = element_text(size = 12, face = "bold"),  # Styling year labels
    panel.spacing = unit(1, "lines")  # Space between facets
  )

timeline_plot

```

## Quarterly Averages

One way to think about tracking data across time is to break the volunteerism down into averages by employee for each quarter. If you remember from the beginning of the report, there are `r total_employees` employees in Acme Corp who cumulatively participated in `r total_activities` activities. On a per-employee per-quarter basis, that breaks down to:

<div style="text-align: center;">
(total activities / total employees) / 8
</div>  

or `r round((total_activities / total_employees)/8,2)` average activities per person each quarter for the Acme Corp as a whole. 

```{r}

# remove after all testing is complete
source('00_custom_theme.R')
theme_set(my_acme_theme)

activities_by_quarter <- df_deidentified %>%
  filter(is_activity) %>%
  mutate(
    year = format(as.Date(activity_date), "%Y"),
    quarter = case_when(
      between(as.Date(activity_date), as.Date("2023-01-01"), as.Date("2023-03-31")) ~ "Q1",
      between(as.Date(activity_date), as.Date("2023-04-01"), as.Date("2023-06-30")) ~ "Q2",
      between(as.Date(activity_date), as.Date("2023-07-01"), as.Date("2023-09-30")) ~ "Q3",
      between(as.Date(activity_date), as.Date("2023-10-01"), as.Date("2023-12-31")) ~ "Q4",
      between(as.Date(activity_date), as.Date("2024-01-01"), as.Date("2024-03-31")) ~ "Q1",
      between(as.Date(activity_date), as.Date("2024-04-01"), as.Date("2024-06-30")) ~ "Q2",
      between(as.Date(activity_date), as.Date("2024-07-01"), as.Date("2024-09-30")) ~ "Q3",
      between(as.Date(activity_date), as.Date("2024-10-01"), as.Date("2024-12-31")) ~ "Q4"
    ),
    quarter_year = paste0(quarter, "_", year) # Unique identifier for pivot_wider
  ) %>%
  group_by(org_group, quarter_year) %>%
  summarize(
    total_activities = n(),
    .groups = "drop"
  ) %>%
  pivot_wider(
    names_from = quarter_year,
    values_from = total_activities,
    values_fill = 0
  )

total_members <- df_deidentified %>%
  group_by(org_group) %>%
  summarize(
    total_members = n_distinct(salesforce_id),
    .groups = "drop"
  )

activities_with_members <- activities_by_quarter %>%
  left_join(total_members, by = "org_group") %>%
  mutate(
    across(starts_with("Q"), ~ . / total_members, .names = "{.col}_per_member")) %>% 
  mutate(
    across(contains("_per_member"), as.numeric), # Ensure all values are numeric
    Total_avg_per_employee = rowMeans(select(., contains("_per_member")), na.rm = TRUE)
  )

activities_averages <- activities_with_members %>%
  select(
    org_group, 
    Q1_2023_per_member, Q2_2023_per_member, Q3_2023_per_member, Q4_2023_per_member, 
    Q1_2024_per_member, Q2_2024_per_member, Q3_2024_per_member, Q4_2024_per_member,
    Total_avg_per_employee
  )

# Compute the overall quarterly average for reference
total_activities <- sum(select(activities_with_members, starts_with("Q")) %>% unlist(), na.rm = TRUE)
total_employees <- sum(total_members$total_members, na.rm = TRUE)
overall_per_quarter_avg <- round(total_activities / (total_employees * 8), 2)  # 8 quarters total

### üìå Pretty Table with Year Headers
pretty_table <- activities_averages %>%
  arrange(desc(Total_avg_per_employee)) %>%
  gt() %>%
  tab_header(
    title = md("**Quarterly Per-Employee Average Activities**")
  ) %>%
  cols_label(
    org_group = "Department",
    Q1_2023_per_member = "Q1",
    Q2_2023_per_member = "Q2",
    Q3_2023_per_member = "Q3",
    Q4_2023_per_member = "Q4",
    Q1_2024_per_member = "Q1",
    Q2_2024_per_member = "Q2",
    Q3_2024_per_member = "Q3",
    Q4_2024_per_member = "Q4",
    Total_avg_per_employee = "Average"
  ) %>%
  tab_spanner(
    label = "2023",
    columns = c(Q1_2023_per_member, Q2_2023_per_member, Q3_2023_per_member, Q4_2023_per_member)
  ) %>%
  tab_spanner(
    label = "2024",
    columns = c(Q1_2024_per_member, Q2_2024_per_member, Q3_2024_per_member, Q4_2024_per_member)
  ) %>%
  data_color(
    columns = c(ends_with("_per_member"), Total_avg_per_employee),
    colors = function(x) de_id_redgreen_gradient((x - overall_per_quarter_avg) / overall_per_quarter_avg)
  ) %>%
  tab_style(
    style = list(
      cell_text(weight = "bold")
    ),
    locations = cells_column_labels(everything())
  ) %>%
  fmt_number(
    columns = c(ends_with("_per_member"), Total_avg_per_employee),
    decimals = 2
  ) %>%
  opt_table_outline(style = "solid", width = px(3), color = "#004d65") %>%
  opt_horizontal_padding(scale = 3)

# reference table
overall_avg_table <- tibble(
  Metric = "Acme Corp Quarterly Average",
  Value = overall_per_quarter_avg
)
reference_table <- overall_avg_table %>%
  gt() %>%
  cols_label(
    Metric = "",
    Value = ""
  ) %>%
  data_color(
    columns = c(Value),
    colors = function(x) de_id_redgreen_gradient((x - overall_per_quarter_avg) / overall_per_quarter_avg)
  ) %>%
  fmt_number(
    columns = c(Value),
    decimals = 2
  ) %>%
  tab_style(
    style = list(cell_text(weight = "bold")),
    locations = cells_column_labels(everything())
  ) %>%
  opt_table_outline(style = "solid", width = px(3), color = "#004d65") %>%
  opt_horizontal_padding(scale = 2)

reference_table
```

This gives us a reference point to assess the per-employee activity rate for each group across 2024. The data are normalized to allow comparison across groups of different sizes. The table cells below are color-coded in reference to the overall Acme Corp quarterly average: **darker greens are farther above the overall average, darker purples are farther below, and the whiteish-yellows are nearly identical.** 

This table provides two main benefits: 

- You can see differences across quarters. 2024 had particularly strong volunteer rates within Sales and Marketing, for instance.
- It makes temporal trends within a single team visible, especially as future data get added. This will allow Acme Corp to see how the per-member volunteer rate within a particular department changes over time.
```{r}
pretty_table
```

# Activity by Department {#team-activity}
A visual breakdown of activity counts by department, with each employee colored according to their investment level. All charts are set to the same x-axis to allow for easy comparison across departments.

Remember that you can refer back to the [Summary by Department](#teams-summary) section to see the per-department breakdown of total employees, activity types, and total activities.

```{r}
global_max_engaged <- df_deidentified %>%
  group_by(org_group, salesforce_id) %>%
  summarize(engaged = sum(is_activity), .groups = "drop") %>%
  pull(engaged) %>%
  max(na.rm = TRUE)

team_activity_plot <- function(df, team = NULL, member_status = NULL, invest_color_pal, global_max_engaged) {
  # Filter by team if provided
  filtered_data <- df
  if (!is.null(team)) {
    filtered_data <- filtered_data %>% filter(org_group == team)
  }
  
  # Filter by org_status if provided
  if (!is.null(member_status)) {
    filtered_data <- filtered_data %>% filter(org_status == member_status)
  }
  
  # Summarize data for plotting
  top_engagers_all <- filtered_data %>%
    group_by(salesforce_id, first_name, last_name, seniority_level) %>%
    summarize(engaged = sum(is_activity), .groups = "drop") %>%
    ungroup() %>%
    arrange(desc(engaged)) %>%
    mutate(
      full_name = paste(first_name, last_name),
      axis_label_color = as.character(seniority_level)
    )
  
  # Adjust order of full_name and colors for plotting
  top_engagers_all <- top_engagers_all %>%
    mutate(full_name = reorder(full_name, engaged))
  
  axis_label_colors <- top_engagers_all %>%
    arrange(full_name) %>%  # Match the ggplot order
    mutate(color = ifelse(!is.na(axis_label_color), invest_color_pal[axis_label_color], "black")) %>%
    pull(color)
  
  # Create the plot
  ggplot(top_engagers_all, aes(x = full_name, y = engaged, fill = seniority_level)) +
    geom_bar(stat = "identity", show.legend = TRUE, width = 0.9) +
    coord_flip() +  
    scale_y_continuous(
      limits = c(0, global_max_engaged), 
      breaks = seq(0, global_max_engaged, by = 5)
    ) +
    scale_fill_manual(values = invest_color_pal) +
    labs(
      title = paste("Count of activities"),
      x = "",
      y = "",
      fill = "Seniority Level",
      color = "Investment Level"
    ) +
    theme(
      plot.title = element_text(hjust = 0.05),
      legend.position = "bottom",
      legend.title = NULL,
      axis.text.y = element_text(
        size = 10,
        face = "bold",
        colour = axis_label_colors,
        lineheight = 1.2
      )
    )
}
```

## Marketing
```{r, fig.height=19, fig.width=8}
team_activity_plot(
  df = df_deidentified,
  team = "Marketing",
  member_status = NULL,
  invest_color_pal = de_id_invest_color_pal,
  global_max_engaged = global_max_engaged
)
```

## Engineering
```{r, fig.height=12, fig.width=8}
team_activity_plot(
  df = df_deidentified,
  team = "Engineering",
  member_status = NULL,
  invest_color_pal = de_id_invest_color_pal,
  global_max_engaged = global_max_engaged
)
```

## Accounting
```{r, fig.height=12, fig.width=8}
team_activity_plot(
  df = df_deidentified,
  team = "Accounting",
  member_status = NULL,
  invest_color_pal = de_id_invest_color_pal,
  global_max_engaged = global_max_engaged
)
```

## Finance
```{r, fig.height=12, fig.width=8}
team_activity_plot(
  df = df_deidentified,
  team = "Finance",
  member_status = NULL,
  invest_color_pal = de_id_invest_color_pal,
  global_max_engaged = global_max_engaged
)

```

## Sales
```{r, fig.height=12, fig.width=8}
team_activity_plot(
  df = df_deidentified,
  team = "Sales",
  member_status = NULL,
  invest_color_pal = de_id_invest_color_pal,
  global_max_engaged = global_max_engaged
)

```

## Data
```{r, fig.height=12, fig.width=8}
team_activity_plot(
  df = df_deidentified,
  team = "Data",
  member_status = NULL,
  invest_color_pal = de_id_invest_color_pal,
  global_max_engaged = global_max_engaged
)

```

## Interns
All the prospective employees are linked to specific groups and are shown in their respective group charts above, but I also wanted to break them out as their own group in case that's helpful. 
```{r, fig.height=8, fig.width=8}
team_activity_plot(
  df = df_deidentified,
  team = NULL,
  member_status = "Intern",
  invest_color_pal = de_id_invest_color_pal,
  global_max_engaged = global_max_engaged
)

```

# Interactive Search

This is an interactive table of the data that underlies everything in this report. A few key points to note: 

- You can use the buttons in the upper left to access the data in different formats, and those outputs will respond to whatever filters you place on the table. So if you filter to just "Jane Doe" and click the CSV button, a CSV file with only Jane's data will download. 

- There is a case-insensitive overall search bar in the upper right. You can sort the entire table in ascending/descending order of each column, you can filter by specific column, and for certain columns that are lists of distinct categories (like Group), you can select one or more of the specific departments. This allows conditional filtering ‚Äî for instance you could filter Investment Level to just "High", and also filter Group to both "Sales" and "Accounting" to show just the employees that meet all of those criteria.  

```{r}
for_table <- df_deidentified %>% 
  select(-salesforce_id, -volunteer_flag) %>% 
  mutate(org_status = as.factor(org_status),
         org_group = as.factor(org_group),
         activity_type = as.factor(activity_type)) %>% 
  select(first_name, last_name, org_group, org_status, seniority_level, city, state_name, county_fips, is_activity, activity_type, activity_date, activity_desc)

pretty_colnames <- c(
  "first_name" = "First Name",
  "last_name" = "Last Name",
  "org_group" = "Organization Group",
  "org_status" = "Organization Status",
  "seniority_level" = "Seniority Level",
  "city" = "City",
  "state_name" = "State",
  "county_fips" = "County FIPS",
  "is_activity" = "Activity (T/F)",
  "activity_type" = "Activity Type",
  "activity_date" = "Activity Date",
  "activity_desc" = "Activity Description"
)

datatable(
  for_table,
  colnames = unname(pretty_colnames),
  rownames = FALSE,
  style = "auto",  
  class = 'hover compact table-bordered stripe',
  filter = 'top',
  extensions = 'Buttons',
  fillContainer = T,
  options = list(
    dom = 'Bftip',  # Display search, table, info, and pagination
    pageLength = 25,  
    autoWidth = T,  
    scrollY = '1000px',
    scrollCollapse = T,
    buttons = c('pdf', 'csv', 'excel', 'print'),
    columnDefs = list(
      list(className = "dt-center", targets = "_all") 
    )
  ),
) %>%
  formatStyle(
    "is_activity",
    backgroundColor = styleEqual(c(TRUE, FALSE), c("#DFF0D8", "#F2DEDE")) 
  ) 

```

<hr style="border: 1px solid #004d65;">
# Recommendations

**[Note]**: for this demonstration I've stripped out the recommendations section as it doesn't make a whole lot of sense to make up a bunch of writing about a bunch of made-up data!
But in the real versions of this general type of report this section has included a detailed list of recommendations for improving program buy-in and efficacy based on the analysis above. 



